SRCDIR=.

SRCS:= \
	$(SRCDIR)/CCID/LOCAL_ACCESS/Debug_T1.c   \
	$(SRCDIR)/CCID/LOCAL_ACCESS/OpenPGP_V20.c   \
	$(SRCDIR)/CCID/UNIT_TEST/SIM_USB_CCID.c   \
	$(SRCDIR)/CCID/USART/ISO7816_ADPU.c   \
	$(SRCDIR)/CCID/USART/ISO7816_Prot_T0.c   \
	$(SRCDIR)/CCID/USART/ISO7816_Prot_T1.c   \
	$(SRCDIR)/CCID/USART/ISO7816_USART.c   \
	$(SRCDIR)/CCID/USART/ISO7816_USART_INT.c   \
	$(SRCDIR)/Cipher/Xts/aescrypt.c   \
	$(SRCDIR)/Cipher/Xts/aeskey.c   \
	$(SRCDIR)/Cipher/Xts/aestab.c   \
	$(SRCDIR)/Cipher/Xts/modetest.c   \
	$(SRCDIR)/Cipher/Xts/xts.c   \
	$(SRCDIR)/FILE_IO/FileAccessInterface.c   \
	$(SRCDIR)/HighLevelFunctions/FlashStorage.c   \
	$(SRCDIR)/HighLevelFunctions/HandleAesStorageKey.c   \
	$(SRCDIR)/HighLevelFunctions/HiddenVolume.c   \
	$(SRCDIR)/HighLevelFunctions/MatrixPassword.c   \
	$(SRCDIR)/HighLevelFunctions/password_safe.c   \
	$(SRCDIR)/INTERNAL_WORK/internal_work.c   \
	$(SRCDIR)/nitrokey.c   \
	$(SRCDIR)/OTP/aes.c   \
	$(SRCDIR)/OTP/hotp.c   \
	$(SRCDIR)/OTP/keyboard.c   \
	$(SRCDIR)/OTP/report_protocol.c   \
	$(SRCDIR)/OTP/sha1.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/BOARDS/EVK1104/led.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/COMPONENTS/MEMORY/DATA_FLASH/AT45DBX/at45dbx.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/COMPONENTS/MEMORY/DATA_FLASH/AT45DBX/at45dbx_mem.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/COMPONENTS/MEMORY/SD_MMC/SD_MMC_MCI/sd_mmc_mci.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/COMPONENTS/MEMORY/SD_MMC/SD_MMC_MCI/sd_mmc_mci_mem.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/ADC/adc.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/AES/aes.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/AES/ram_aes_ram_example.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/FLASHC/flashc.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/GPIO/gpio.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/INTC/intc.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/MCI/mci.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/PM/pm.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/PM/pm_conf_clocks.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/PM/power_clocks_lib.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/SPI/spi.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/TC/tc.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USART/usart.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/ENUM/DEVICE/usb_descriptors.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/ENUM/DEVICE/usb_device_task.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/ENUM/DEVICE/usb_specific_request.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/ENUM/DEVICE/usb_standard_request.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/ENUM/HOST/usb_host_task.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/ENUM/usb_task.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/usb_drv.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FAT/fat.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FAT/fat_unusual.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FAT/file.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FAT/fsaccess.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FAT/navigation.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FREERTOS/Source/croutine.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FREERTOS/Source/list.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FREERTOS/Source/portable/GCC/AVR32_UC3/port.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FREERTOS/Source/portable/MemMang/heap_3.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FREERTOS/Source/queue.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FREERTOS/Source/tasks.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/MEMORY/CTRL_ACCESS/ctrl_access.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/aes.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/arc4.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/base64.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/bignum.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/camellia.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/certs.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/debug.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/des.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/dhm.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/havege.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/md2.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/md4.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/md5.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/net.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/padlock.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/rsa.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/sha1.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/sha2.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/sha4.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/ssl_cli.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/ssl_srv.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/ssl_tls.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/timing.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/x509parse.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/xtea.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/USB/CLASS/MASS_STORAGE/device_mass_storage_task.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/USB/CLASS/MASS_STORAGE/host_mass_storage_task.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/USB/CLASS/MASS_STORAGE/SCSI_DECODER/scsi_decoder.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/UTILS/DEBUG/debug.c   \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/UTILS/DEBUG/print_funcs.c   \
	$(SRCDIR)/Tools/AD_Test.c   \
	$(SRCDIR)/Tools/BUFFERED_SIO.c   \
	$(SRCDIR)/tools.c   \
	$(SRCDIR)/Tools/DebugLog.c   \
	$(SRCDIR)/Tools/DFU_test.c   \
	$(SRCDIR)/Tools/fastHash.c   \
	$(SRCDIR)/Tools/Inbetriebnahme.c   \
	$(SRCDIR)/Tools/Interpreter.c   \
	$(SRCDIR)/Tools/LED_test.c   \
	$(SRCDIR)/Tools/OTP_Test.c   \
	$(SRCDIR)/Tools/SD_Test.c   \
	$(SRCDIR)/Tools/TIME_MEASURING.c   \
	$(SRCDIR)/Tools/xxHash.c   \
	$(SRCDIR)/USB_CCID/USB_CCID.c   \
	$(SRCDIR)/USB_CCID/USB_CCID_task.c   \
	$(SRCDIR)/USER_INTERFACE/file_io.c   \
	$(SRCDIR)/USER_INTERFACE/html_io.c   \
	$(SRCDIR)/USHELL/ushell_task.c   \
	$(SRCDIR)/VIRTUAL_MEM/virtual_mem.c   \
	$(SRCDIR)/OTP/hmac-sha1.c \




SRCSASM:= \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FREERTOS/Source/portable/GCC/AVR32_UC3/exception.x \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/UTILS/STARTUP_FILES/GCC/crt0.x \
	$(SRCDIR)/SOFTWARE_FRAMEWORK/ASM/trampoline.x

OBJS := ${SRCS:.c=.o}
OBJSASM := ${SRCSASM:.x=.o}

CC:=avr32-gcc
INC:= \
	-I$(SRCDIR) \
	-I$(SRCDIR)/CCID/LOCAL_ACCESS \
	-I$(SRCDIR)/CONFIG \
	-I$(SRCDIR)/INTERNAL_WORK \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/BOARDS \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/COMPONENTS/MEMORY/DATA_FLASH/AT45DBX \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/COMPONENTS/MEMORY/SD_MMC/SD_MMC_MCI \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/ADC \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/AES \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/CPU/CYCLE_COUNTER \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/FLASHC \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/GPIO \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/INTC \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/MCI \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/PM \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/SPI \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/TC \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USART \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/ENUM \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/ENUM/DEVICE \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/DRIVERS/USBB/ENUM/HOST \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FAT \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FREERTOS/Source/include \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/FREERTOS/Source/portable/GCC/AVR32_UC3 \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/MEMORY/CTRL_ACCESS \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/POLARSSL/include \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/USB \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/USB/CLASS/MASS_STORAGE \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/USB/CLASS/MASS_STORAGE/HOST_MEM \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/SERVICES/USB/CLASS/MASS_STORAGE/SCSI_DECODER \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/UTILS \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/UTILS/DEBUG \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/UTILS/LIBS/NEWLIB_ADDONS/INCLUDE \
	-I$(SRCDIR)/SOFTWARE_FRAMEWORK/UTILS/PREPROCESSOR \
	-I$(SRCDIR)/Tools \
	-I$(SRCDIR)/USHELL \
	-I$(SRCDIR)/VIRTUAL_MEM \

RUN:=$(CC) -DBOARD=EVK1104 -DFREERTOS_USED $(INC) -O0 -fdata-sections -g3 -Wall -c -fmessage-length=0 -mpart=uc3a3256s -ffunction-sections -masm-addr-pseudos

RUNLINK:= $(CC) -nostartfiles -L$(SRCDIR)/SOFTWARE_FRAMEWORK/UTILS/LIBS/NEWLIB_ADDONS -L$(SRCDIR)/SOFTWARE_FRAMEWORK/BOARDS -Wl,--gc-sections -Wl,-e,_trampoline -T$(SRCDIR)/SOFTWARE_FRAMEWORK/UTILS/LINKER_SCRIPTS/AT32UC3A3/256/GCC/link_uc3a3256.lds -mpart=uc3a3256s -Wl,--gc-sections --rodata-writable -Wl,--direct-data

RUNLINK2:=-lnewlib_addons-at32ucr2-speed_opt

RUNASM:=$(CC) -x assembler-with-cpp -c -mpart=uc3a3256s -Wa,-g $(INC) -Wa,-g3

all: USB_MASS.elf
	ls -lh $<

clean:
	rm $(OBJS) $(OBJSASM)

USB_MASS.elf: $(OBJS) $(OBJSASM)
	$(RUNLINK) -o$@ $^  $(RUNLINK2)
	ls -lh $@

%.o: %.c
	$(RUN) -o $@ $<

%.o: %.x
	$(RUNASM) -o $@ $<

